{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "threat-model-schema.json",
  "title": "Threat Model Schema",
  "description": "Schema for threat modeling toolkit state files",

  "definitions": {
    "asset": {
      "type": "object",
      "required": ["id", "name", "type"],
      "properties": {
        "id": { "type": "string", "pattern": "^asset-[0-9]{3,}$" },
        "name": { "type": "string" },
        "type": { "type": "string", "enum": ["data-store", "service", "client", "integration", "infrastructure", "identity", "secret"] },
        "classification": { "type": "string", "enum": ["public", "internal", "confidential", "restricted"] },
        "description": { "type": "string" },
        "owner": { "type": "string" },
        "location": {
          "type": "object",
          "properties": {
            "type": { "type": "string", "enum": ["cloud", "on-premise", "hybrid", "edge"] },
            "provider": { "type": "string" },
            "region": { "type": "string" },
            "service": { "type": "string" }
          }
        },
        "data_types": { "type": "array", "items": { "type": "string" } },
        "dependencies": { "type": "array", "items": { "type": "string" } },
        "code_references": { "type": "array", "items": { "type": "string" } },
        "metadata": {
          "type": "object",
          "properties": {
            "created": { "type": "string", "format": "date-time" },
            "updated": { "type": "string", "format": "date-time" },
            "source": { "type": "string" }
          }
        }
      }
    },
    "dataflow": {
      "type": "object",
      "required": ["id", "name", "source", "destination"],
      "properties": {
        "id": { "type": "string", "pattern": "^flow-[0-9]{3,}$" },
        "name": { "type": "string" },
        "source": {
          "type": "object",
          "properties": {
            "asset_id": { "type": "string" },
            "component": { "type": "string" }
          }
        },
        "destination": {
          "type": "object",
          "properties": {
            "asset_id": { "type": "string" },
            "component": { "type": "string" }
          }
        },
        "data_types": { "type": "array", "items": { "type": "string" } },
        "protocol": { "type": "string" },
        "port": { "type": "integer" },
        "authentication": { "type": "string" },
        "encryption": {
          "type": "object",
          "properties": {
            "in_transit": { "type": "boolean" },
            "algorithm": { "type": "string" }
          }
        },
        "crosses_trust_boundary": { "type": "boolean" },
        "trust_boundary_id": { "type": "string" },
        "code_references": { "type": "array", "items": { "type": "string" } }
      }
    },
    "trust_boundary": {
      "type": "object",
      "required": ["id", "name", "type"],
      "properties": {
        "id": { "type": "string", "pattern": "^tb-[0-9]{3,}$" },
        "name": { "type": "string" },
        "type": { "type": "string", "enum": ["network", "process", "privilege", "environment", "organizational", "data-classification"] },
        "description": { "type": "string" },
        "inside": { "type": "array", "items": { "type": "string" } },
        "outside": { "type": "array", "items": { "type": "string" } },
        "controls_required": { "type": "array", "items": { "type": "string" } },
        "flows_crossing": { "type": "array", "items": { "type": "string" } }
      }
    },
    "attack_surface": {
      "type": "object",
      "required": ["id", "name", "type", "asset_id"],
      "properties": {
        "id": { "type": "string", "pattern": "^as-[0-9]{3,}$" },
        "name": { "type": "string" },
        "type": { "type": "string", "enum": ["api", "web-ui", "mobile", "cli", "admin", "integration", "file-upload", "message-queue"] },
        "asset_id": { "type": "string" },
        "exposure": { "type": "string", "enum": ["public", "internal", "restricted"] },
        "endpoints": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": { "type": "string" },
              "methods": { "type": "array", "items": { "type": "string" } },
              "authentication": { "type": "string" },
              "authorization": { "type": "string" },
              "rate_limited": { "type": "boolean" },
              "input_validation": { "type": "boolean" }
            }
          }
        },
        "technologies": { "type": "array", "items": { "type": "string" } },
        "code_references": { "type": "array", "items": { "type": "string" } }
      }
    },
    "threat": {
      "type": "object",
      "required": ["id", "title", "category"],
      "properties": {
        "id": { "type": "string", "pattern": "^threat-[0-9]{3,}$" },
        "title": { "type": "string" },
        "category": { "type": "string", "enum": ["spoofing", "tampering", "repudiation", "information-disclosure", "denial-of-service", "elevation-of-privilege"] },
        "framework": { "type": "string", "enum": ["STRIDE", "PASTA", "custom"] },
        "description": { "type": "string" },
        "target": {
          "type": "object",
          "properties": {
            "asset_id": { "type": "string" },
            "attack_surface_id": { "type": "string" },
            "entry_point": { "type": "string" }
          }
        },
        "threat_actor": { "type": "string" },
        "attack_vector": { "type": "string" },
        "prerequisites": { "type": "array", "items": { "type": "string" } },
        "impact": {
          "type": "object",
          "properties": {
            "confidentiality": { "type": "string", "enum": ["none", "low", "medium", "high"] },
            "integrity": { "type": "string", "enum": ["none", "low", "medium", "high"] },
            "availability": { "type": "string", "enum": ["none", "low", "medium", "high"] }
          }
        },
        "likelihood": { "type": "string", "enum": ["rare", "unlikely", "possible", "likely", "almost-certain"] },
        "risk_score": { "type": "number", "minimum": 0, "maximum": 25 },
        "risk_level": { "type": "string", "enum": ["low", "medium", "high", "critical"] },
        "related_threats": { "type": "array", "items": { "type": "string" } },
        "mitre_attack": { "type": "array", "items": { "type": "string" } },
        "cwe": { "type": "array", "items": { "type": "string" } },
        "countermeasures": { "type": "array", "items": { "type": "string" } }
      }
    },
    "control": {
      "type": "object",
      "required": ["id", "name", "type"],
      "properties": {
        "id": { "type": "string", "pattern": "^control-[0-9]{3,}$" },
        "name": { "type": "string" },
        "type": { "type": "string", "enum": ["preventive", "detective", "corrective", "deterrent", "compensating"] },
        "category": { "type": "string" },
        "description": { "type": "string" },
        "threats_mitigated": { "type": "array", "items": { "type": "string" } },
        "implementation": {
          "type": "object",
          "properties": {
            "status": { "type": "string", "enum": ["implemented", "partial", "planned", "missing"] },
            "method": { "type": "string" },
            "configuration": { "type": "object" }
          }
        },
        "verification": {
          "type": "object",
          "properties": {
            "status": { "type": "string", "enum": ["verified", "unverified", "failed"] },
            "evidence": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "type": { "type": "string", "enum": ["code", "config", "test", "documentation"] },
                  "location": { "type": "string" },
                  "verified_at": { "type": "string", "format": "date-time" }
                }
              }
            }
          }
        },
        "effectiveness": { "type": "number", "minimum": 0, "maximum": 1 },
        "compliance_mappings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "framework": { "type": "string" },
              "requirement": { "type": "string" }
            }
          }
        }
      }
    },
    "gap": {
      "type": "object",
      "required": ["id", "control_id", "title", "severity"],
      "properties": {
        "id": { "type": "string", "pattern": "^gap-[0-9]{3,}$" },
        "control_id": { "type": "string" },
        "title": { "type": "string" },
        "description": { "type": "string" },
        "expected": { "type": "string" },
        "actual": { "type": "string" },
        "severity": { "type": "string", "enum": ["low", "medium", "high", "critical"] },
        "evidence": {
          "type": "object",
          "properties": {
            "code_search": { "type": "string" },
            "config_check": { "type": "string" }
          }
        },
        "remediation": {
          "type": "object",
          "properties": {
            "recommendation": { "type": "string" },
            "effort": { "type": "string", "enum": ["low", "medium", "high"] },
            "priority": { "type": "string", "enum": ["low", "medium", "high", "critical"] }
          }
        },
        "related_threats": { "type": "array", "items": { "type": "string" } }
      }
    },
    "risk_register_entry": {
      "type": "object",
      "required": ["id", "threat_id", "title"],
      "properties": {
        "id": { "type": "string", "pattern": "^risk-[0-9]{3,}$" },
        "threat_id": { "type": "string" },
        "title": { "type": "string" },
        "category": { "type": "string" },
        "likelihood": {
          "type": "object",
          "properties": {
            "score": { "type": "integer", "minimum": 1, "maximum": 5 },
            "rationale": { "type": "string" }
          }
        },
        "impact": {
          "type": "object",
          "properties": {
            "score": { "type": "integer", "minimum": 1, "maximum": 5 },
            "rationale": { "type": "string" }
          }
        },
        "inherent_risk_score": { "type": "number" },
        "inherent_risk_level": { "type": "string", "enum": ["low", "medium", "high", "critical"] },
        "controls": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "control_id": { "type": "string" },
              "effectiveness": { "type": "number" },
              "status": { "type": "string" }
            }
          }
        },
        "residual_risk_score": { "type": "number" },
        "residual_risk_level": { "type": "string", "enum": ["low", "medium", "high", "critical"] },
        "treatment": { "type": "string", "enum": ["accept", "mitigate", "transfer", "avoid"] },
        "treatment_plan": { "type": "string" },
        "owner": { "type": "string" },
        "review_date": { "type": "string", "format": "date" },
        "status": { "type": "string", "enum": ["open", "in-progress", "closed", "accepted"] }
      }
    }
  },

  "type": "object",
  "properties": {
    "version": { "type": "string", "const": "1.0" },
    "metadata": {
      "type": "object",
      "properties": {
        "project": { "type": "string" },
        "created": { "type": "string", "format": "date-time" },
        "updated": { "type": "string", "format": "date-time" },
        "framework": { "type": "string" },
        "author": { "type": "string" }
      }
    },
    "assets": { "type": "array", "items": { "$ref": "#/definitions/asset" } },
    "dataflows": { "type": "array", "items": { "$ref": "#/definitions/dataflow" } },
    "trust_boundaries": { "type": "array", "items": { "$ref": "#/definitions/trust_boundary" } },
    "attack_surface": { "type": "array", "items": { "$ref": "#/definitions/attack_surface" } },
    "threats": { "type": "array", "items": { "$ref": "#/definitions/threat" } },
    "controls": { "type": "array", "items": { "$ref": "#/definitions/control" } },
    "gaps": { "type": "array", "items": { "$ref": "#/definitions/gap" } },
    "risk_register": { "type": "array", "items": { "$ref": "#/definitions/risk_register_entry" } }
  }
}
